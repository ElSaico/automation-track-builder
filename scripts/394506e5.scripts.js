"use strict";angular.module("automationTrackBuilderApp",[]),angular.module("automationTrackBuilderApp").factory("trackOverview",["$rootScope",function(){return function(a){var b=new fabric.Canvas(a,{containerClass:"center-block"}),c=new fabric.Image;return c.set({scaleX:.5,scaleY:.5,selectable:!1}),b.add(c),{setBackground:function(a){c.setElement(a),b.renderAll()}}}}]).controller("MainCtrl",["$scope","trackOverview",function(a,b){var c,d,e=0,f=1,g=-1;a.name="Track",a.start={x:640,y:360},a.split1=1,a.split2=2,a.scale={pixels:20,meters:10},a.corners=[],a.selected=-1,a.defaultCorner={layout:0,layoutInfo:100,radius:0,slope:0,camber:0,sportiness:0};var h=function(a,d){return function(){c||(c=b("track-overview"));var e=document.getElementById(a),f=new FileReader;f.onloadend=function(a){d(a.target.result)},e.onchange=function(a){f.readAsDataURL(a.target.files[0])},e.click()}};a.loadBG=h("background-file",function(a){var b=new Image;b.src=a,b.onload=function(){c.setBackground(b)}}),a.importFile=h("import-file",function(b){if("data:text/x-lua;base64,"!=b.substr(0,23))throw Error("Not a Lua script");var c=atob(b.substr(23)),d=luaparse.parse(c);d.body.forEach(function(b){if("Track"==b.variables[0].name){var c={STRAIGHT:0,LEFT:1,RIGHT:-1},d={start:{},scale:{},layout:[],layoutInfo:[],cornerRadius:[],slope:[],sportiness:[],camber:[],corners:[]};b.init[0].fields.forEach(function(a){switch(a.key.name){case"Name":d.name=a.value.value;break;case"Split1":d.split1=a.value.value;break;case"Split2":d.split2=a.value.value;break;case"Start":d.start={x:a.value.fields[0].value.value,y:a.value.fields[1].value.value};break;case"Scale":if("/"!=a.value.operator)throw Error("Scale must be a pixels/length division");d.scale={pixels:a.value.left.value,meters:a.value.right.value};break;case"Layout":a.value.fields.forEach(function(a){"Identifier"==a.value.type?d.layout.push(c[a.value.name]):"NumericLiteral"==a.value.type&&d.layout.push(a.value.value)});break;case"LayoutInfo":a.value.fields.forEach(function(a){d.layoutInfo.push(a.value.value)});break;case"CornerRadius":a.value.fields.forEach(function(a){d.cornerRadius.push(a.value.value)});break;case"Slope":a.value.fields.forEach(function(a){d.slope.push("-"==a.value.operator?-a.value.argument.value:a.value.value)});break;case"Sportiness":a.value.fields.forEach(function(a){d.sportiness.push(a.value.value)});break;case"Camber":a.value.fields.forEach(function(a){d.camber.push("-"==a.value.operator?-a.value.argument.value:a.value.value)})}});for(var e=0;e<d.layout.length;e++)d.corners.push({layout:d.layout[e],layoutInfo:d.layoutInfo[e],radius:d.cornerRadius[e],slope:d.slope[e],sportiness:d.sportiness[e],camber:d.camber[e]});delete d.layout,delete d.layoutInfo,delete d.cornerRadius,delete d.slope,delete d.sportiness,delete d.camber,Object.keys(d).forEach(function(b){a[b]=d[b]}),a.selected=d.corners.length-1,a.$apply()}})}),a.exportFile=function(){d||(d=angular.element("#track-template").text(),Mustache.parse(d));var b={name:a.name,start:a.start,split1:a.split1,split2:a.split2,scale:a.scale,layout:[],layoutInfo:[],cornerRadius:[],slope:[],sportiness:[],camber:[]};a.corners.forEach(function(a){switch(a.layout){case 0:b.layout.push("STRAIGHT");break;case 1:b.layout.push("LEFT");break;case-1:b.layout.push("RIGHT")}b.layoutInfo.push(a.layoutInfo),b.cornerRadius.push(a.radius),b.slope.push(a.slope),b.sportiness.push(a.sportiness),b.camber.push(a.camber)});var c=Mustache.render(d,b);window.open("data:text/x-lua;base64,"+btoa(c),"_blank")},a.cornerPush=function(){var b=angular.copy(a.defaultCorner),c=a.corners.push(b);a.selected=c-1},a.cornerPop=function(){a.corners.pop(),a.selected=Math.min(a.selected,a.corners.length-1)},a.cornerStraight=function(){a.corners[a.selected].layout!=e&&(a.corners[a.selected].layoutInfo=a.corners[a.selected].radius,a.corners[a.selected].radius=0),a.corners[a.selected].layout=e},a.cornerLeft=function(){a.corners[a.selected].layout==e&&(a.corners[a.selected].radius=a.corners[a.selected].layoutInfo,a.corners[a.selected].layoutInfo=90),a.corners[a.selected].layout=f},a.cornerRight=function(){a.corners[a.selected].layout==e&&(a.corners[a.selected].radius=a.corners[a.selected].layoutInfo,a.corners[a.selected].layoutInfo=90),a.corners[a.selected].layout=g}}]);